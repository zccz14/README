现在是 2026 年 2 月 10 日，晚上。

# 三体门控的市场状态量建模方案

承接 [三体动力学假说](../INSIGHTS/9.md) 和 [门控机制的设想](./59.md)，本文梳理 $\delta$, $\mu$, $\sigma$ 三个市场状态量的具体建模方案。

输入：K 线序列 $(O_t, H_t, L_t, C_t, V_t)$。

## 1. $\mu$（动量）：收益率的移动平均

令对数收益率 $r_t = \ln C_t - \ln C_{t-1}$，动量定义为收益率的指数移动平均：

$$\mu_t = \text{EMA}(r_t, n_\mu)$$

$\mu$ 是价格序列经过带通滤波后的输出，提取的是"中频"方向性运动——即趋势。高频噪声被 EMA 平滑掉，低频漂移因为 $r_t$ 本身是差分量而被去除。

这与双均线策略的信号本质相同：$\text{EMA}_{fast} - \text{EMA}_{slow}$ 也是 $r_t$ 的线性滤波器（可严格证明），只是脉冲响应形状不同。因此 $\mu$ 的建模没有争议，任何动量指标都是 $r_t$ 的线性函数，区别仅在滤波器参数。

## 2. $\sigma$（波动率）：收益率的标准差

$$\sigma_t = \text{StdDev}(r_t, n_\sigma)$$

即滚动窗口内对数收益率的标准差。这是最经典的已实现波动率估计，在期权定价中被广泛使用。

$\sigma$ 的计算包含一个关键的非线性操作——平方（或取绝对值），这使得它丢弃了方向信息，只保留振幅。从信号处理的角度看，这是一个**包络检测**操作：先对信号取绝对值/平方（非线性整流），再低通滤波（滚动窗口平均），得到振荡幅度的缓慢变化。

正因为这个非线性操作，$\sigma$ 与 $\mu$ 之间不存在线性关系，两者是独立的信息维度。

## 3. $\delta$（溢价）：成交量引力场模型

### 3.1 为什么 $\delta$ 不能用均线偏离来定义

假说中 $\delta = (S - S^*) / S^*$，如果用移动平均线作为 $S^*$，可以严格证明：

$$\ln S_t - \text{EMA}(\ln S_t, N) = \frac{\lambda}{\alpha} \cdot \text{EMA}(r_t, N)$$

其中 $\lambda = 1 - \alpha$。即**价格对均线的偏离，严格等于同周期 EMA(r) 的常数倍**。

这意味着用均线定义的 $\delta$ 与 $\mu$ 线性相关，不构成独立维度。无论用单层均线还是多层级联均线，只要是线性滤波器，$\delta$ 都会退化为 $\mu$ 的变体。

要让 $\delta$ 独立，必须引入非线性操作。

### 3.2 内在价值是市场内生的：心理锚定效应

我们认为内在价值 $S^*$ 不是市场外生变量，而是市场参与者通过交易行为"投票"出来的共识价格。

核心观察：**买卖双方达成价格共识才能带来成交量**。成交量越大的价格区间，意味着市场对该价格的认可度越高，心理锚定效应越强。

因此，$S^*$ 不是一个值，而是一个分布——成交量在价格轴上的分布。成交密集区就是共识区（箱体震荡区域、支撑阻力带），成交稀疏区就是非共识区（价格快速通过的区域）。

### 3.3 从离散锚点到连续引力场

一种自然的想法是先识别成交密集区（锚点），再计算价格对锚点的偏离。但锚点的识别本身需要峰值检测，引入额外的建模层和参数。

更干净的做法：**不显式识别锚点，让每一笔成交直接对当前价格施加锚定效应**。

每一份在 $P_i$ 成交的量 $V_i$，都对当前价格 $S_t$ 产生一个"引力"。锚点不需要被定义——它们作为引力场的高密度区域自然涌现。

### 3.4 核函数 $K(S, P)$：锚定效应的心理模型

核函数 $K(S, P)$ 描述：**在 $P$ 成交的人，当价格变为 $S$ 时，其锚定效应有多强。**

选择高斯核：

$$K(S, P) = \exp\left(-\frac{(S - P)^2}{2h^2}\right)$$

$h$ 是带宽参数，含义是锚定效应的作用半径。$h$ 可以设为当前波动率 $\sigma$ 的倍数，使其自适应市场状态——高波动时人们对"合理价格"的容忍范围更大。

核函数的形状编码了心理假设，不同的核会产生不同的 $\delta$，进而产生不同的门控效果。门控效果的好坏反过来验证哪种心理模型更接近现实。

第一版使用对称高斯核。但核函数可能是非对称的，理由如下：

每笔成交都有买方和卖方，乍看之下，买方的损失侧（$S < P$）和卖方的损失侧（$S > P$）方向相反，不对称性应当互相抵消。但**处置效应**打破了这个对称——人们倾向于卖出盈利头寸、持有亏损头寸。这意味着盈利方逐渐离场（锚定效应消失），亏损方持续留在市场（锚定效应持续）。经过这层"存活者筛选"后，市场中残留的锚定效应天然偏向损失侧。

进一步，在多数市场（股票、加密货币）中存在**多头偏向**——做多的参与者远多于做空的参与者。因此聚合效应是：$S < P$（多头亏损侧）的锚定效应更强，$S > P$（多头盈利侧）的锚定效应更弱。这与经验观察一致——支撑位通常比阻力位更"硬"。

未来可以考虑使用分裂正态核（左右带宽不同的高斯核）来建模这种不对称性，并通过门控效果的对比来验证其是否显著。

### 3.5 $\delta$ 的定义：引力场的梯度

定义成交量引力场：

$$F(S) = \sum_i V_i \cdot e^{-\kappa(t - t_i)} \cdot K(S, P_i)$$

其中 $e^{-\kappa(t - t_i)}$ 是时间衰减——越久远的成交，锚定效应越弱。

$\delta$ 定义为引力场对价格的**负梯度**（即"拉回力"的方向和大小）：

$$\delta_t = -\frac{\partial F}{\partial S}\bigg|_{S=S_t} = \sum_i V_i \cdot e^{-\kappa(t - t_i)} \cdot \frac{P_i - S_t}{h^2} \cdot \exp\left(-\frac{(S_t - P_i)^2}{2h^2}\right)$$

行为特征：

- $S_t$ 在成交密集区中心：两侧引力对称抵消，$\delta \approx 0$（无溢价）
- $S_t$ 偏离密集区：引力不对称，$\delta$ 指向密集区（有溢价，存在回归力）
- $S_t$ 远离所有成交区：所有引力都很弱（进入未知领域，锚定效应消失）

## 4. 从 K 线序列的具体计算

### 4.1 $\mu$ 和 $\sigma$ 的计算

直接从收盘价序列计算，无特殊处理：

```python
r[t] = log(C[t]) - log(C[t-1])
μ[t] = EMA(r, n_μ)[t]
σ[t] = StdDev(r, n_σ)[t]
```

### 4.2 $\delta$ 的计算：价格轴离散化

逐笔累加所有历史成交不现实。实用做法是将价格轴离散化为 $N$ 个 bin，维护一个引力质量向量 $G[1..N]$。

**步骤 1：K 线成交量分配**

每根 K 线的成交量 $V_t$ 需要分配到价格轴上。K 线只提供 OHLCV，不提供逐笔数据。一种合理近似：将 $V_t$ 均匀分配到 $[L_t, H_t]$ 范围内的所有 bin 上。

```python
for bin_j in bins_between(L[t], H[t]):
    G[j] += V[t] / count_of_bins_between(L[t], H[t])
```

**步骤 2：时间衰减**

每根新 K 线到来时，对整个 $G$ 向量施加时间衰减：

```python
G[:] *= exp(-κ)
```

**步骤 3：计算 $\delta$**

```python
δ[t] = Σ_j G[j] · (P_j - S[t]) / h² · exp(-(S[t] - P_j)² / (2h²))
```

由于高斯核的快速衰减，只需对 $S_t$ 附近若干个 bin 求和（例如 $|P_j - S_t| < 3h$ 的范围）。

### 4.3 bin 的设计

建议在对数价格轴上等间距划分 bin，这样每个 bin 代表相同的百分比价格区间。bin 的宽度应远小于 $h$，以保证核函数的平滑性。

## 5. 三变量的独立性

| 变量对 | 为什么独立 |
| ------ | ---------- |
| $\mu$ vs $\sigma$ | $\sigma$ 的计算包含取平方/绝对值操作（非线性），丢弃了方向信息 |
| $\delta$ vs $\mu$ | $\delta$ 基于成交量在价格轴上的分布（核密度估计 + 梯度），$\mu$ 基于收益率的线性滤波。核密度估计是非线性操作，且 $\delta$ 的输入包含成交量 $V_t$，这是 $\mu$ 完全不使用的信息 |
| $\delta$ vs $\sigma$ | 同理，$\delta$ 依赖成交量分布结构，$\sigma$ 仅依赖收益率幅度 |

关键点：$\delta$ 的独立性来自两个非线性操作——核函数（高斯指数）和梯度计算，以及额外的信息源（成交量）。这从根本上避免了均线偏离方案中 $\delta$ 退化为 $\mu$ 变体的问题。

## 6. 参数总结

| 参数 | 含义 | 建议范围 |
| ---- | ---- | -------- |
| $n_\mu$ | 动量平滑窗口 | 与信号策略的均线参数一致 |
| $n_\sigma$ | 波动率计算窗口 | 与 $n_\mu$ 相同或稍大 |
| $h$ | 核函数带宽（锚定效应作用半径） | 可设为 $c \cdot \sigma_t$，自适应 |
| $\kappa$ | 时间衰减率（锚定效应遗忘速度） | 需实验确定 |

其中 $h = c \cdot \sigma_t$ 的设计使得带宽自适应市场状态：高波动时锚定效应的作用范围更宽，低波动时更窄。$c$ 是一个无量纲常数。

## 参考

- [资本市场的三体动力学假说](../INSIGHTS/9.md)
- [门控机制的设想](./59.md)
- [反马丁投注策略的实验结果](./58.md)
