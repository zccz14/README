---
"title": "全スペクトル分析法：情報の最適な実現方法"
"summary": "本稿では、ケリー基準に基づいて最適化された投資取引戦略フレームワークである全スペクトル分析法（FSA）を提案します。まず、従来のケリー公式が投資応用において持つ限界（レバレッジと空売りの考慮不足、清算タイミングの問題など）を分析します。次に、FSAは結果空間の定義、最適レバレッジと複利収益率の計算を通じて、体系的な取引意思決定モデルを構築します。本稿では、期待収益率と複利収益率の計算、ニュートン法を用いた最適レバレッジ求解アルゴリズムを含むFSAの数学的原理を詳細に説明します。さらに、歴史的バックテスト方法（粗利益率GPMの計算など）、実取引モジュールの考慮事項、ブラックスワン事象への対応策についても紹介します。FSAの核心的な利点は、不完全な確率情報を活用し、レバレッジ意思決定を最適化することで長期的な収益を最大化し、情報の質に対する高い要求を低減できる点にあります。"
"tags":
  - "全スペクトル分析法"
  - "ケリー公式"
  - "投資戦略"
  - "レバレッジ最適化"
  - "複利収益率"
  - "リスク管理"
  - "アルゴリズム取引"
  - "ブラックスワン事象"
"date": "2025-08-10"
---

# 全スペクトル分析法：情報の最適な実現方法

2025-08-10

## 背景

**資産の成長率を最大化するには？**

1956年、J.L. Kellyは『A New Interpretation of Information Rate』（情報率の新たな解釈）を発表しました。この論文は、既知の情報を利用して資産の複利成長率を最大化する方法について論じています。これは、賭けの掛け金戦略を導く確率論的手法を提案しました。しかし、この論文を実際の投資活動に適用するには、いくつかの問題があります：

1.  借入レバレッジと空売りを考慮しておらず、論文の結論は0〜1の実質レバレッジ範囲に留まっています。
2.  賭け人が賭けるのは特定の事象記号であり、次にそれが発生すれば配当を得るが、そうでなければ賭け金を失うと仮定しています。しかし、トレーダーは買い/売りに賭けることしかできず、買いと売りが対応する上昇/下落事象は、異なる時間枠において異なる結果と異なる収益率を示します。
3.  清算タイミング：ケリーは賭けの終了・清算が賭け人の意志で決まらないと仮定しています。しかし、トレーダーはいつでもポジションを解消するか継続するかを決めることができます。
4.  冗長なベイズ的手法：事象の展開が事前確率と条件付き確率に関連すると仮定しています。ベイズ的手法を取り除いても導出される数学的本質には影響せず、直接的に論文の公式を使用する難易度を高めています。実際の使用には簡略化が必要です。

我々は、ケリー論文の確率論的手法を踏襲し、投資取引分野に適用可能な実用的な戦略を探求します。

## 全スペクトル分析法：Full-Spectrum Analysis, FSA

### 結果空間、最適レバレッジ、最適収益率

ある取引戦略を実行すると、最終的にいくつかの異なる結果事象が生じると仮定します。結果空間を $X$ とします。$X$ は空ではありません（実際のシナリオでは少なくとも2つの結果が存在します）。

追加の仮定：

1.  確定的な収益：各結果事象は明確な収益率に対応します。結果 $i$ の収益率を $R_i$ とします。
    1.  ✅ 異なる収益率の事象は、異なる結果事象として扱うべきです。例えば、1%の利益と2%の利益は異なります。
    1.  ❌ 明らかに異なる収益率の利益事象を同じ結果にまとめることは、確定的収益の仮定に反します。
1.  確定的な確率：結果 $i \in X$ が発生する確率を $P_i$ とします（$0 \le P_i \le 1$）。
    1.  ✅ 各結果の確率は確定的に評価される必要があります。
    1.  ❌ ある結果が発生する可能性が8割以上（80%〜100%）であると考えることは、確定的確率の仮定に反します。
1.  排反性：2つの結果が同時に発生することは不可能です。
    1.  ✅ 絶対に同時に発生しない結果事象を設計する必要があります。
    1.  ❌ 結果事象に共通部分が存在する場合（例：「20分間ポジションを保有する」と「20%下落する」事象が同時に発生する可能性がある）、排反性に反します。
1.  完全性：すべての結果が発生する確率の合計は100%であり、事前に定義された結果以外の結果は存在しません。つまり、$\sum_{i \in X} P_i = 1$ です。
    1.  ✅ 発生する可能性のあるすべての結果を考慮する必要があります。
    1.  ❌ 結果事象として「20%以上上昇」、「20%以上下落」のみを定義し、「-20%〜20%の間で変動」を定義していない場合、完全性に反します。
1.  レバレッジ効果：収益率はレバレッジ効果に従います。つまり、$k$ 倍のレバレッジを使用する場合、結果 $i$ が発生すると、収益率は $k \cdot R_i$ となり、資産は元の $1 + k \cdot R_i$ 倍になります。
1.  ✅ 流動性が十分に高い投資商品はこの特性に適合します。
1.  ❌ 保有額が高すぎる場合、流動性の理由から市場インパクトコストが発生し、収益は線形関係に従わなくなります。

結果空間 $X$ に対して、**期待収益率 Expected Earning Yield** を計算できます：
$$E(X) = \sum_{i \in X} P_i R_i$$

期待収益率の考え方は直感的で計算も容易です。期待収益率の問題点は：

1.  導かれる意思決定が極端で、ポジションなしかフルポジションかのどちらかになり、破産リスクを制御できません。期待収益率が正の場合、たとえ高レバレッジが破産をもたらす可能性があっても、より高い収益率を求めてレバレッジを無限に拡大する傾向があります。
2.  複利効果を考慮していません。単一の投資の収益状況のみを考慮しており、市場が繰り返し投資可能であることを考慮していません。実際の投資管理の状況には適合しません。

**複利収益率 Compound Earning Yield** とは、独立した取引を複数回繰り返した後、1回の取引あたりに均等化された収益率のことです：

$$C(X, k) = (\prod_{i \in X} (1 + k \cdot R_i)^{P_i}) - 1$$

**最適収益率 Optimal Earning Yield** は、異なるレバレッジにおける複利収益率の最大値です：

$$O(X) = \max_k C(X, k)$$

破産してゼロにならないためには、すべての結果に対して $1 + k \cdot R_i >0$ が満たされる必要があり、これから $k$ の基本的な実行可能領域 $K$ を導出できます：

上限：

$$\max k = \max(0, \min_{R_i < 0} {-\frac{1}{R_i}})$$

下限：

$$\min k = \min(0, \max_{R_i > 0} {-\frac{1}{R_i}})$$

そして常に実行可能な解 $k = 0$ があります。

$$K = (\min k, \max k) \cup \{ 0 \}$$

最適レバレッジとは、実行可能領域 $K$ 内で複利収益率 $C(X, k)$ を最大化する $k$ のことです。

$$k_o = \argmax_k C(X, k)$$

任意の時点で、口座の実質レバレッジ $k = \frac{ポジション規模}{口座純資産}$ を計算でき、最適レバレッジ $k_o$ を評価できます。
すべての取引戦略は、最終的に実質レバレッジに対応します。確定的な取引意思決定を行うことは、$k$ の値を決定することと等価です。そして最適レバレッジは理想的なポジション保有に対応します。

これにより、以下の取引フレームワークが得られます：

1.  結果空間 $X$ を設計する。
2.  異なる結果の確率 $P$ を継続的に評価する。
3.  実質レバレッジ $k$ と最適レバレッジ $k_O$ を計算する。
4.  実質レバレッジを最適レバレッジに近づけるように制御する。

> **特殊点**
>
> 自明な点 $C(X, 0) = 0$、すなわち「参加しなければ損益は発生しない」。
> 我々がポジションを持っていないとき、それは $k = 0$ と決定することと等価です。あらゆる銘柄について、ポジションの有無に関わらず、我々は常に意思決定を行っています。
> 空売りは $k < 0$ の場合です。もし $|k| > 1$ ならば、追加のレバレッジが必要であることを意味します。

### 最適化問題の求解

問題を振り返ると、結果空間 $X$、確率分布 $P_i$、収益率 $E_i$、実行可能領域 $[L, R]$ が既知であり、収益率を最大化するレバレッジ率 $k \in [L, R]$ を求めることです：

複利収益率を移項整理し、両辺に対数を取ると（単調性は保たれます）、以下が得られます：

$$\ln (1 + C(X, k)) = \sum_{i \in X} P_i \ln (1 + k \cdot R_i)$$

ここで、

$$G(k) = \ln(1 + C(X, k)) = \sum_{i \in X} P_i \ln (1 + k R_i)$$

最適レバレッジの定義によれば：

$$k_o = \argmax_k C(X, k)$$

$f(x) = \ln(1+x)$ は単調増加関数なので：

$$k_o = \argmax_k C(X, k) = \argmax_k G(k)$$

$G(k)$ の一次導関数、二次導関数を求めます：

$$G'(k) = \sum_{i \in X} \frac{P_i R_i}{1 + k R_i} $$

$$G''(k) = \sum\_{i \in X} -\frac{P_i R_i^2}{(1 + k R_i)^2} $$

二次導関数の各項は非正なので、$G''(k) \le 0$ です。$P_i R_i \equiv 0$ の場合に限り $G''(k) = 0$ となりますが、この場合 $G(k) \equiv 0$ であり、収益が全くなく実質的な意味はありません。それ以外の場合、$G''(k) < 0$ です。これは $G(k)$ が厳密な凹関数であり、$G'(k)$ が厳密に単調減少であることを意味します。 $G(k)$ には唯一つの極大点があり、この極大点が最大値点です。

下図に示すように、項数がいくつであっても、$G(k)$ の曲線は凹関数です。

![ケリー公式-曲線の概略図](image-1.png)

$G(k)$ の極大点は、その一次導関数の零点です：

$$G'(k) = \sum_{i \in X} \frac{P_i R_i}{1 + k R_i} = 0$$

この方程式を整理すると、$k$ に関する多項式方程式に変換できます。
$R_i$ の異なる値が $N$ 個存在する場合、上記の多項式方程式の最高次数は $N-1$ です。
アーベル-ルフィニの定理によれば、五次以上の多項式には一般的な根の公式が存在しません。

一般的なケリー公式は、$N=2$ の特殊なケースです：勝率を $p$、配当率を $b$ とします。

| 結果 | 確率  | 収益率 |
| ---- | ----- | ------ |
| 勝   | $p$   | $b$    |
| 負   | $1-p$ | $-1$   |

代入して方程式を得ます：

$$G'(k) = \frac{pb}{1+kb} + \frac{-(1-p)}{1 -k} = 0$$

整理すると、

$$k = \frac{p(b+1)-1}{b}$$

これがケリー公式です。

取引シナリオでは、異なる収益率の結果が無数に現れる可能性があるため、数値解を求めるしかありません。

単変数の厳密な凹関数として、ニュートン法を用いて求解することが最良の選択です。
不動点 $$G(0) = 0$$ から反復を開始するのは良い選択です。厳密な凹関数では、どの点から開始しても同じ結果に収束します。

#### ニュートン法が実行可能領域を超える場合

潜在的な問題は、ニュートン法で得られた反復点が、問題の実行可能領域を超える可能性があることです。
最小化の例でこの状況を説明します：

$$p_1 = 0.9, r_1 = 0.5, p_2 = 0.1, r_2 = -1$$

これより、

$$G(k) = 0.9 \times \ln(1+0.5k) + 0.1 \times \ln(1 - k)$$

![G(k) 関数のグラフ](image-2.png)

計算により実行可能領域 $K = (-2, 1)$ が得られ、解析的な最適レバレッジは $k_o = 0.7$ です。
しかし、ニュートン法を使用する場合、最初の反復点は

$$G(0) - \frac{G'(0)}{G''(0)} = \frac{14}{13} > 1$$

![G‘(k) 及びニュートン法のデモンストレーション](image-3.png)

最初の反復点で実行可能領域を超え、導関数の定義域を超えてしまうため、さらに反復することは無意味です。これは、単純なニュートン法自体では実行可能領域を超える状況を処理できないことを示しています。

解決方法は、ニュートン法で反復点を計算した後、それが実行可能領域内にあるかどうかを追加で判断することです。領域内であればその点に反復し、領域外であればその方向に応じて、実行可能領域の境界と現在の点との間の点を次の反復点とします。

#### アルゴリズムの疑似コード

アルゴリズム $\text{resolve}(G, L, R, \epsilon = 10^{-9}, N = 100, \alpha = 0.9)$

1.  $k \gets 0$ で初期化
2.  収益率 $r_i$ に基づいて、基本的な実行可能領域 $K$ を計算
3.  実行可能領域をクリップ： $L \gets \max(L, \min K), R \gets \min(R, \max K)$
4.  最大 $N$ 回ループ：

    1.  次の点を計算：$k' \gets k - \frac{G'(k)}{G''(k)}$
    2.  もし $k'$ が $K$ に属さない場合

        1.  もし $k' \ge R$ なら、 $k' \gets \alpha R + (1-\alpha)k$ とする
        2.  もし $k' \le L$ なら、 $k' \gets \alpha L + (1 - \alpha) k$ とする

    3.  差が精度閾値 $| k' - k | < \epsilon$ より小さければ、ループを抜ける。
    4.  $k \gets k'$ で更新

5.  $k$ を返す

#### コード実装

プログラミングの観点では、より適切な抽象化は、結果集合の各結果が収益率 r と重み w の2つの属性を持つとすることです。この結果空間は走査可能であり、アルゴリズムは以下のように記述できます：

```ts
/**
 * ケリー基準に基づき、最適レ