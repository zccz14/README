---
"title": "全スペクトル分析法：情報の最適な実現方法"
"summary": "本稿では、投資取引分野における最適レバレッジ決定のため、ケリー基準を改良した全スペクトル分析法（FSA）を提案します。この手法は、結果空間の定義、期待収益率と複利収益率の計算を通じて、長期複合成長を最大化する最適レバレッジを求めます。文書では、FSAの数学的原理、アルゴリズム実装（ニュートン法による求解とブラックスワン事象の処理を含む）、歴史的バックテスト手法（粗利益率GPMの計算など）、および実取引モジュールへの応用について詳細に説明します。FSAは、不完全な確率情報を活用し、算出された最適レバレッジを厳密に遵守することで、情報実現の品質ハードルを下げ、従来の最尤法の限界を回避することを目的としています。"
"tags":
  - "全スペクトル分析法"
  - "ケリーの公式"
  - "最適レバレッジ"
  - "複利収益率"
  - "投資戦略"
  - "リスク管理"
  - "アルゴリズム取引"
  - "確率モデル"
"inferred_date": "2025-08-10"
"inferred_lang": "zh-Hans"
---

# 全スペクトル分析法：情報の最適な実現方法

2025-08-10

## 背景

**資産の成長率を最大化するにはどうすればよいか？**

1956年、J.L. Kellyは『A New Interpretation of Information Rate』（情報率の新たな解釈）を発表しました。この論文は、既知の情報を利用して資産の複合成長率を最大化する方法について論じています。これは、賭けの賭け方戦略を確率的に導く方法を提案しています。しかし、この論文を実際の投資活動に適用するには、いくつかの問題があります：

1.  借入レバレッジと空売りを活用していないため、論文の結論は0〜1の実質レバレッジ範囲に留まっています。
2.  賭け人が賭けるのはある事象記号であり、次にそれが発生すれば配当を得るが、そうでなければ賭け金を失うと仮定しています。しかし、トレーダーは買い（ロング）または売り（ショート）にしか賭けることができず、ロング/ショートに対応する上昇/下落事象は、異なる時間枠において異なる結果と異なる収益率を示します。
3.  清算タイミング：ケリーは、賭けの終了・清算は賭け人の意志では決まらないと仮定しています。しかし、トレーダーはいつでもポジションを解消するか、継続するかを決定できます。
4.  冗長なベイズ的手法：事象の展開は事前確率と条件付き確率に関連すると仮定しています。ベイズ的手法を取り除いても、導出される数学的本質には影響しません。難易度を増大させ、論文の公式を直接使用するのは難しく、実際の使用には簡略化が必要です。

我々は、ケリー論文の確率的手法を踏襲し、投資取引分野に適用可能な実用的な戦略を探求します。

## 全スペクトル分析法：Full-Spectrum Analysis, FSA

### 結果空間、最適レバレッジ、最適収益率

ある取引戦略を実行すると、最終的にいくつかの異なる結果事象が生じると仮定します。結果空間を $X$ とします。$X$ は空ではありません（実際のシナリオでは少なくとも2つの結果が存在します）。

追加の仮定：

1.  確定収益：各結果事象は明確な収益率に対応します。結果 $i$ の収益率を $R_i$ とします。
    1.  ✅ 異なる収益率の事象は、異なる結果事象として扱うべきです。例えば、利益1%と利益2%は異なります。
    1.  ❌ 明らかに異なる収益率の利益事象を同じ結果にまとめることは、確定収益の仮定に反します。
1.  確定確率：結果 $i \in X$ が発生する確率を $P_i$ とします（$0 \le P_i \le 1$）。
    1.  ✅ 各結果の確率は確定的に評価される必要があります。
    1.  ❌ ある結果が発生する可能性が8割以上（80%〜100%）であると考えることは、確定確率の仮定に反します。
1.  排反性：2つの結果が同時に発生することは不可能です。
    1.  ✅ 絶対に同時に発生しない結果事象を設計する必要があります。
    1.  ❌ 結果事象に共通部分が存在する場合（例：「20分間ポジションを保有する」と「20%下落する」事象が同時に発生する可能性がある）、排反性に反します。
1.  完全性：すべての結果が発生する確率の合計は100%であり、事前に定義された結果以外の結果は存在しません。つまり、$\sum_{i \in X} P_i = 1$ です。
    1.  ✅ 発生する可能性のあるすべての結果を考慮する必要があります。
    1.  ❌ 結果事象として「20%以上上昇」、「20%以上下落」のみを定義し、「-20%〜20%の間で変動」を定義していない場合、完全性に反します。
1.  レバレッジ効果：収益率はレバレッジ効果に従います。つまり、$k$ 倍のレバレッジを使用する場合、結果 $i$ が発生すると、収益率は $k \cdot R_i$ となり、資産は元の $1 + k \cdot R_i$ 倍になります。
    1.  ✅ 流動性が十分に高い投資商品はこの特性を満たします。
    1.  ❌ 保有額が高すぎる場合、流動性の理由から市場インパクトコストが発生し、収益は線形関係に従わなくなります。

結果空間 $X$ に対して、**期待収益率 Expected Earning Yield** を計算できます：
$$E(X) = \sum_{i \in X} P_i R_i$$

期待収益率の考え方は直感的で、計算も容易です。期待収益率の問題点は：

1.  導かれる決定が極端で、ポジションなしかフルポジションかのどちらかになり、破産リスクを制御できません。期待収益率が正の場合、たとえ高レバレッジが破産をもたらす可能性があっても、より高い収益率を得るためにレバレッジを無限に拡大する傾向があります。
2.  複利効果を考慮していません。単一の投資の収益状況のみを考慮しており、市場が繰り返し投資可能であることを考慮していません。実際の投資管理の状況に適合しません。

**複利収益率 Compound Earning Yield** とは、独立した取引を複数回繰り返した後、単一の取引あたりに均した収益率のことです：

$$C(X, k) = (\prod_{i \in X} (1 + k \cdot R_i)^{P_i}) - 1$$

**最適収益率 Optimal Earning Yield** は、異なるレバレッジにおける複利収益率の最大値です：

$$O(X) = \max_k C(X, k)$$

破産してゼロにならないためには、すべての結果に対して $1 + k \cdot R_i >0$ が満たされる必要があり、これから $k$ の基本的な実行可能領域 $K$ を導出できます：

上限：

$$\max k = \max(0, \min_{R_i < 0} {-\frac{1}{R_i}})$$

下限：

$$\min k = \min(0, \max_{R_i > 0} {-\frac{1}{R_i}})$$

および常に実行可能な解 $k = 0$、

$$K = (\min k, \max k) \cup \{ 0 \}$$

最適レバレッジとは、実行可能領域 $K$ 内で、複利収益率 $C(X, k)$ を最大化する $k$ のことです。

$$k_o = \argmax_k C(X, k)$$

任意の時点で、口座内の実質レバレッジ $k = \frac{ポジション規模}{口座純資産}$ を計算でき、最適レバレッジ $k_o$ を評価できます。
すべての取引戦略は、最終的に実質レバレッジに対応します。確定的な取引決定を行うことは、$k$ の値を決定することと等価です。そして、最適レバレッジは理想的なポジション保有に対応します。

これにより、以下の取引フレームワークが得られます：

1.  結果空間 $X$ を設計する。
2.  異なる結果の確率 $P$ を継続的に評価する。
3.  実質レバレッジ $k$ と最適レバレッジ $k_O$ を計算する。
4.  実質レバレッジを最適レバレッジに近づけるように制御する。

> **特殊点**
>
> 自明な点 $C(X, 0) = 0$、すなわち「参加しなければ損益は発生しない」。
> ポジションを持っていないとき、我々は $k = 0$ と決定したことと等価です。どの商品についても、ポジションの有無にかかわらず、我々は常に決定を行っています。
> 空売りは $k < 0$ の場合です。もし $|k| > 1$ ならば、追加のレバレッジが必要であることを意味します。

### 最適化問題の求解

問題を振り返ると、結果空間 $X$、確率分布 $P_i$、収益率 $E_i$、実行可能領域 $[L, R]$ が既知であり、収益率を最大化するレバレッジ率 $k \in [L, R]$ を求めることです：

複利収益率を移項整理し、両辺の対数を取ると（単調性は保持されます）、以下が得られます：

$$\ln (1 + C(X, k)) = \sum_{i \in X} P_i \ln (1 + k \cdot R_i)$$

ここで、

$$G(k) = \ln(1 + C(X, k)) = \sum_{i \in X} P_i \ln (1 + k R_i)$$

最適レバレッジの定義によると：

$$k_o = \argmax_k C(X, k)$$

$f(x) = \ln(1+x)$ は単調増加関数なので：

$$k_o = \argmax_k C(X, k) = \argmax_k G(k)$$

$G(k)$ の一次導関数、二次導関数を求めます：

$$G'(k) = \sum_{i \in X} \frac{P_i R_i}{1 + k R_i} $$

$$G''(k) = \sum\_{i \in X} -\frac{P_i R_i^2}{(1 + k R_i)^2} $$

二次導関数の各項は非正なので、$G''(k) \le 0$ です。$P_i R_i \equiv 0$ の場合に限り $G''(k) = 0$ となりますが、この場合 $G(k) \equiv 0$ となり、収益が全くなく実質的な意味がありません。それ以外の場合、$G''(k) < 0$ です。これは $G(k)$ が厳密な凹関数であり、$G'(k)$ が厳密に単調減少であることを意味します。 $G(k)$ には唯一つの極大点があり、この極大点が最大点です。

下図に示すように、項数がいくつであっても、$G(k)$ の曲線は凹関数です。

![ケリーの公式-曲線の概略図](image-1.png)

$G(k)$ の極大点は、その一次導関数の零点です：

$$G'(k) = \sum_{i \in X} \frac{P_i R_i}{1 + k R_i} = 0$$

この方程式を整理すると、$k$ に関する多項式方程式に変換できます。
$R_i$ の異なる値が $N$ 個存在する場合、上記の多項式方程式の最高次数は $N-1$ です。
アーベル-ルフィニの定理によれば、五次以上の多項式には一般的な根の公式がありません。

一般的なケリーの公式は、$N=2$ の特殊な場合です：勝率 $p$、オッズ $b$ とします。

| 結果 | 確率  | 収益率 |
| ---- | ----- | ------ |
| 勝   | $p$   | $b$    |
| 負   | $1-p$ | $-1$   |

代入して方程式を得ます：

$$G'(k) = \frac{pb}{1+kb} + \frac{-(1-p)}{1 -k} = 0$$

整理すると、

$$k = \frac{p(b+1)-1}{b}$$

これがケリーの公式です。

取引シナリオでは、異なる収益率の結果が無数に現れる可能性があるため、数値解を求めるしかありません。

単変数の厳密な凹関数として、ニュートン法による求解が最適な選択です。
不動点 $$G(0) = 0$$ から反復を開始するのは良い選択です。厳密な凹関数では、どの点から開始しても同じ結果に収束します。

#### ニュートン法が実行可能領域を超える場合

潜在的な問題は、ニュートン法で得られた反復点が、問題の実行可能領域を超える可能性があることです。
最小化の例でこの状況を説明します：

$$p_1 = 0.9, r_1 = 0.5, p_2 = 0.1, r_2 = -1$$

これより、

$$G(k) = 0.9 \times \ln(1+0.5k) + 0.1 \times \ln(1 - k)$$

![G(k) 関数のグラフ](image-2.png)

計算により実行可能領域 $K = (-2, 1)$ が得られ、解析的最適レバレッジは $k_o = 0.7$ です。
しかし、ニュートン法を使用する場合、最初の反復点は

$$G(0) - \frac{G'(0)}{G''(0)} = \frac{14}{13} > 1$$

![G‘(k) およびニュートン法のデモンストレーション](image-3.png)

最初の反復点で実行可能領域を超え、導関数の定義域を超えてしまうため、さらに反復しても意味がありません。これは、単純なニュートン法自体では、実行可能領域を超える状況を処理できないことを示しています。

解決方法は、ニュートン法で反復点を計算した後、それが実行可能領域内にあるかどうかを追加で判断することです。領域内であればその点に反復し、領域外であればその方向に応じて、実行可能領域の境界と現在の点との間の点を次の反復点とします。

#### アルゴリズムの疑似コード

アルゴリズム $\text{resolve}(G, L, R, \epsilon = 10^{-9}, N = 100, \alpha = 0.9)$

1.  初期化 $k \gets 0$
2.  収益率 $r_i$ に基づき、基本的な実行可能領域 $K$ を計算
3.  実行可能領域をクリップ $L \gets \max(L, \min K), R \gets \min(R, \max K)$
4.  最大 $N$ 回ループ：

    1.  次の点を計算 $k' \gets k - \frac{G'(k)}{G''(k)}$
    2.  もし $k'$ が $K$ に属さない場合

        1.  もし $k' \ge R$ なら、$k' \gets \alpha R + (1-\alpha)k$ とする
        2.  もし $k' \le L$ なら、$k' \gets \alpha L + (1 - \alpha) k$ とする

    3.  差が精度閾値より小さい場合 $| k' - k | < \epsilon$、ループを抜ける。
    4.  更新 $k \gets k'$

5.  $k$ を返す

#### コード実装

プログラミングの観点では、より適切な抽象化は、結果集合の各結果が収益率 r と重み w の2つの属性を持つとすることです。この結果空間は走査可能であり、アルゴリズムは以下のように記述できます：

```ts
/**
 * ケリー基準に基づき、最適レバレッジ k と期待収益 e を計算します。
 *
 * @param R - 収益率ベクトル
 * @param W - 重みベクトル
 * @param lower - 最小レバレッ